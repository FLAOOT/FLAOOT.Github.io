<!DOCTYPE html>
<html>
<head>
    <title>TeleCraft Fixed</title>
    <style>
        /* ... (previous styles remain unchanged) ... */
    </style>
</head>
<body>
    <div id="loading">Loading... <progress id="load-progress" value="0" max="100"></progress></div>
    <!-- ... (other elements remain) ... -->

    <script>
        // ... (previous variable declarations) ...

        async function init() {
            try {
                showLoading(0);
                
                // Async initialization
                await initializeScene();
                await generateWorldAsync(16, 16, 16);
                await initializeUI();

                hideLoading();
                startGame();
            } catch (e) {
                handleError(e);
            }
        }

        async function initializeScene() {
            return new Promise((resolve) => {
                scene = new THREE.Scene();
                scene.background = new THREE.Color('#18222d');

                // Initialize WebGLRenderer with fallback
                try {
                    renderer = new THREE.WebGLRenderer({ antialias: true });
                } catch (e) {
                    alert('WebGL is not supported!');
                    throw e;
                }

                renderer.setSize(window.innerWidth, window.innerHeight);
                document.body.appendChild(renderer.domElement);

                // Camera setup
                camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                camera.position.set(8, 15, 8);
                camera.lookAt(0, 0, 0);

                // Lighting
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
                scene.add(ambientLight);
                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                directionalLight.position.set(1, 1, 1);
                scene.add(directionalLight);

                resolve();
            });
        }

        async function generateWorldAsync(width, height, depth) {
            return new Promise((resolve) => {
                let generated = 0;
                const totalBlocks = width * height * depth;
                
                const generateChunk = () => {
                    for (let i = 0; i < 1000 && generated < totalBlocks; i++) {
                        const x = Math.floor(generated / (height * depth));
                        const y = Math.floor((generated % (height * depth)) / depth);
                        const z = generated % depth;
                        
                        const type = y === height - 1 ? 1 : y >= height - 3 ? 2 : 3;
                        addBlock(x, y, z, type);
                        
                        generated++;
                        if (generated % 100 === 0) {
                            showLoading((generated / totalBlocks) * 100);
                        }
                    }

                    if (generated < totalBlocks) {
                        requestAnimationFrame(generateChunk);
                    } else {
                        resolve();
                    }
                };

                generateChunk();
            });
        }

        function showLoading(progress) {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('load-progress').value = progress;
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('info').style.display = 'block';
            document.getElementById('hotbar').style.display = 'flex';
        }

        function startGame() {
            // Initialize controls
            document.addEventListener('keydown', onKeyDown);
            document.addEventListener('keyup', onKeyUp);
            document.addEventListener('mousedown', onMouseDown);
            document.addEventListener('mousemove', onMouseMove);
            
            // Initialize raycaster
            raycaster = new THREE.Raycaster();
            
            // Start animation loop
            animate();
        }

        // ... (rest of the previous code remains) ...

        // Initialize the game properly
        window.addEventListener('DOMContentLoaded', () => {
            init().catch(handleError);
        });

        function handleError(e) {
            console.error('Error:', e);
            document.getElementById('loading').innerHTML = 
                `<div style="color: red">Error: ${e.message}</div>`;
        }
    </script>
</body>
</html>
