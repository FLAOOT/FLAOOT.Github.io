<!DOCTYPE html>
<html>
<head>
    <title>Minecraft Fixed</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: Arial, sans-serif; }
        #crosshair {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 24px;
            pointer-events: none;
            text-shadow: 2px 2px 2px rgba(0,0,0,0.5);
        }
        #hotbar {
            position: fixed;
            bottom: 20px;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 5px;
        }
        .slot {
            width: 40px;
            height: 40px;
            border: 2px solid #555;
            background: #333;
            cursor: pointer;
            position: relative;
        }
        .active {
            border-color: #ff0;
            box-shadow: 0 0 10px #ff0;
        }
    </style>
</head>
<body>
    <div id="crosshair">+</div>
    <div id="hotbar"></div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // Проверка поддержки WebGL
        if (!WEBGL.isWebGLAvailable()) {
            document.body.innerHTML = '<h1 style="color:red">WebGL не поддерживается вашим браузером!</h1>';
            throw new Error('WebGL не поддерживается');
        }

        const clock = new THREE.Clock();
        let scene, camera, renderer, raycaster;
        
        // Основные настройки
        const SETTINGS = {
            moveSpeed: 5,
            lookSpeed: 0.002,
            gravity: 9.8,
            jumpForce: 8,
            worldSize: 50,
            renderDistance: 16
        };

        // Состояние игры
        let gameState = {
            blocks: new Map(),
            player: {
                position: new THREE.Vector3(0, 15, 0),
                velocity: new THREE.Vector3(),
                canJump: false,
                inventory: [],
                selectedSlot: 0
            },
            keys: {}
        };

        // Материалы блоков
        const MATERIALS = {
            grass: new THREE.MeshPhongMaterial({ color: 0x50C878 }),
            dirt: new THREE.MeshPhongMaterial({ color: 0x806040 }),
            stone: new THREE.MeshPhongMaterial({ color: 0x808080 })
        };

        function init() {
            // Инициализация сцены
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB);

            // Настройка камеры
            camera = new THREE.PerspectiveCamera(
                75,
                window.innerWidth / window.innerHeight,
                0.1,
                1000
            );
            camera.position.copy(gameState.player.position);
            camera.lookAt(0, 0, 0);

            // Инициализация рендерера
            renderer = new THREE.WebGLRenderer({
                antialias: true,
                powerPreference: "high-performance"
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            // Освещение
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(100, 100, 100);
            scene.add(directionalLight);
            
            const ambientLight = new THREE.AmbientLight(0x404040);
            scene.add(ambientLight);

            // Генерация мира
            generateWorld();
            initHotbar();

            // Обработчики событий
            setupEventListeners();

            // Запуск игрового цикла
            animate();

            console.log('Игра успешно инициализирована!');
        }

        function generateWorld() {
            // Генерация стартовой платформы
            const PLATFORM_SIZE = 7;
            for(let x = -PLATFORM_SIZE; x <= PLATFORM_SIZE; x++) {
                for(let z = -PLATFORM_SIZE; z <= PLATFORM_SIZE; z++) {
                    addBlock(x, 10, z, 'grass');
                    addBlock(x, 9, z, 'dirt');
                    addBlock(x, 8, z, 'stone');
                }
            }
            console.log(`Сгенерировано ${gameState.blocks.size} блоков`);
        }

        function addBlock(x, y, z, type) {
            const key = `${x}|${y}|${z}`;
            if (gameState.blocks.has(key)) return;

            const geometry = new THREE.BoxGeometry(1, 1, 1);
            const material = MATERIALS[type];
            const cube = new THREE.Mesh(geometry, material);
            
            cube.position.set(x, y, z);
            cube.userData = { type };
            
            scene.add(cube);
            gameState.blocks.set(key, cube);
        }

        function initHotbar() {
            const hotbar = document.getElementById('hotbar');
            const items = ['grass', 'dirt', 'stone'];
            
            items.forEach((item, index) => {
                const slot = document.createElement('div');
                slot.className = 'slot';
                slot.style.backgroundColor = MATERIALS[item].color.getStyle();
                slot.dataset.item = item;
                slot.onclick = () => selectSlot(index);
                
                if (index === 0) slot.classList.add('active');
                hotbar.appendChild(slot);
            });
        }

        function selectSlot(index) {
            document.querySelectorAll('.slot').forEach(slot => 
                slot.classList.remove('active'));
            document.querySelectorAll('.slot')[index].classList.add('active');
            gameState.player.selectedSlot = index;
        }

        function updatePlayer(delta) {
            // Применяем гравитацию
            gameState.player.velocity.y -= SETTINGS.gravity * delta;

            // Движение
            const direction = new THREE.Vector3();
            if (gameState.keys['w']) direction.z -= 1;
            if (gameState.keys['s']) direction.z += 1;
            if (gameState.keys['a']) direction.x -= 1;
            if (gameState.keys['d']) direction.x += 1;

            direction.normalize();
            direction.applyEuler(new THREE.Euler(0, camera.rotation.y, 0));
            
            const moveVector = direction.multiplyScalar(SETTINGS.moveSpeed * delta);
            gameState.player.position.add(moveVector);
            gameState.player.position.add(gameState.player.velocity.clone().multiplyScalar(delta));

            // Прыжок
            if (gameState.keys[' '] && gameState.player.canJump) {
                gameState.player.velocity.y = SETTINGS.jumpForce;
                gameState.player.canJump = false;
            }

            // Обновление позиции камеры
            camera.position.copy(gameState.player.position);
            camera.position.y += 0.9;
        }

        function animate() {
            requestAnimationFrame(animate);
            const delta = Math.min(0.05, clock.getDelta());
            
            if (document.pointerLockElement === document.body) {
                updatePlayer(delta);
            }

            renderer.render(scene, camera);
        }

        function setupEventListeners() {
            // Обработчики событий ввода
            document.addEventListener('click', () => {
                if (document.pointerLockElement !== document.body) {
                    document.body.requestPointerLock();
                }
            });

            document.addEventListener('mousemove', (e) => {
                if (document.pointerLockElement === document.body) {
                    camera.rotation.y -= e.movementX * SETTINGS.lookSpeed;
                    camera.rotation.x = THREE.MathUtils.clamp(
                        camera.rotation.x - e.movementY * SETTINGS.lookSpeed,
                        -Math.PI/2,
                        Math.PI/2
                    );
                }
            });

            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });

            // Обработчики клавиатуры
            document.addEventListener('keydown', (e) => {
                gameState.keys[e.key.toLowerCase()] = true;
                if (e.key === 'Escape') document.exitPointerLock();
            });

            document.addEventListener('keyup', (e) => {
                gameState.keys[e.key.toLowerCase()] = false;
            });
        }

        // Запуск игры
        init();
    </script>
</body>
</html>
